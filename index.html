<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Management - Frontend Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        
        input, button, select {
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>?? Excel Data Management API - Frontend Demo</h1>
    
    <div id="connection-status" class="status info">
        ?? API ba�lant�s� kontrol ediliyor...
    </div>

    <!-- Dosya Y�kleme B�l�m� -->
    <div class="section">
        <h2>?? Dosya Y�kleme</h2>
        <p>Excel dosyas� (.xlsx, .xls) se�in ve y�kleyin:</p>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <input type="email" id="userEmail" placeholder="Email adresiniz (opsiyonel)" />
        <button onclick="uploadFile()">?? Dosyay� Y�kle</button>
        
        <div id="upload-status"></div>
    </div>

    <!-- Dosya Listesi -->
    <div class="section">
        <h2>?? Y�klenmi� Dosyalar</h2>
        <button onclick="loadFiles()">?? Dosya Listesini Yenile</button>
        <div id="file-list"></div>
    </div>

    <!-- Veri G�r�nt�leme -->
    <div class="section">
        <h2>?? Veri G�r�nt�leme</h2>
        <div>
            <input type="text" id="displayFileName" placeholder="Dosya ad�" />
            <input type="text" id="displaySheetName" placeholder="Sheet ad� (opsiyonel)" />
            <input type="number" id="pageNumber" placeholder="Sayfa" value="1" min="1" />
            <button onclick="displayData()">??? Verileri G�ster</button>
        </div>
        <div id="data-display"></div>
    </div>

    <!-- Dosya Kar��la�t�rma -->
    <div class="section">
        <h2>?? Dosya Kar��la�t�rma</h2>
        <div>
            <input type="text" id="compareFile1" placeholder="1. Dosya ad�" />
            <input type="text" id="compareFile2" placeholder="2. Dosya ad�" />
            <input type="text" id="compareSheetName" placeholder="Sheet ad� (opsiyonel)" />
            <button onclick="compareFiles()">?? Dosyalar� Kar��la�t�r</button>
        </div>
        <div id="comparison-result"></div>
    </div>

    <!-- Veri ��lemleri -->
    <div class="section">
        <h2>?? Veri ��lemleri</h2>
        
        <h3>? Yeni Sat�r Ekle</h3>
        <div>
            <input type="text" id="addFileName" placeholder="Dosya ad�" />
            <input type="text" id="addSheetName" placeholder="Sheet ad�" />
            <textarea id="addRowData" placeholder='Sat�r verisi (JSON): {"Ad": "Ali", "Soyad": "Veli"}'></textarea>
            <button onclick="addRow()">? Sat�r Ekle</button>
        </div>

        <h3>?? Excel Export</h3>
        <div>
            <input type="text" id="exportFileName" placeholder="Dosya ad�" />
            <input type="text" id="exportSheetName" placeholder="Sheet ad� (opsiyonel)" />
            <label>
                <input type="checkbox" id="includeHistory" />
                De�i�iklik ge�mi�ini dahil et
            </label>
            <button onclick="exportData()">?? Excel Olarak �ndir</button>
        </div>
    </div>

    <!-- API Test -->
    <div class="section">
        <h2>?? API Test</h2>
        <button onclick="testExcelApi()">?? Excel API Test</button>
        <button onclick="testComparisonApi()">?? Comparison API Test</button>
        <div id="test-results"></div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { ExcelApiService } from './excel-api-service.js';
        
        // Global service instance
        window.excelService = new ExcelApiService('http://localhost:5002/api');
        
        // Ba�lant� durumunu kontrol et
        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            try {
                const response = await window.excelService.testApi();
                if (response.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '? API ba�lant�s� ba�ar�l�! Backend �al���yor.';
                    loadFiles(); // Otomatik dosya listesi y�kle
                } else {
                    throw new Error('API test ba�ar�s�z');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '? API ba�lant�s� ba�ar�s�z! Backend �al��m�yor olabilir.';
                console.error('Ba�lant� hatas�:', error);
            }
        }
        
        // Sayfa y�klendi�inde ba�lant�y� test et
        document.addEventListener('DOMContentLoaded', checkConnection);
        
        // Global fonksiyonlar� tan�mla
        window.uploadFile = uploadFile;
        window.loadFiles = loadFiles;
        window.displayData = displayData;
        window.compareFiles = compareFiles;
        window.addRow = addRow;
        window.exportData = exportData;
        window.testExcelApi = testExcelApi;
        window.testComparisonApi = testComparisonApi;
        window.editRow = editRow;
        window.deleteRow = deleteRow;
    </script>

    <script>
        // Dosya y�kleme
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const userEmail = document.getElementById('userEmail').value || undefined;
            const statusDiv = document.getElementById('upload-status');
            
            try {
                if (!fileInput.files || fileInput.files.length === 0) {
                    throw new Error('L�tfen bir dosya se�in');
                }
                
                statusDiv.className = 'status info';
                statusDiv.innerHTML = '?? Dosya y�kleniyor...';
                
                const result = await window.excelService.uploadExcelFile(fileInput.files[0], userEmail);
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `? Dosya ba�ar�yla y�klendi: ${result.data.originalFileName}`;
                    loadFiles(); // Dosya listesini yenile
                    
                    // Dosyay� otomatik oku
                    await window.excelService.readExcelData(result.data.fileName);
                    statusDiv.innerHTML += '<br>?? Dosya verileri okundu ve veritaban�na kaydedildi.';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `? Y�kleme hatas�: ${error.message}`;
            }
        }
        
        // Dosya listesini y�kle
        async function loadFiles() {
            const container = document.getElementById('file-list');
            
            try {
                container.innerHTML = '?? Y�kleniyor...';
                
                const result = await window.excelService.getFiles();
                
                if (result.success && result.data && result.data.length > 0) {
                    let html = '<table><tr><th>Dosya Ad�</th><th>Boyut</th><th>Y�klenme Tarihi</th><th>��lemler</th></tr>';
                    
                    result.data.forEach(file => {
                        html += `
                            <tr>
                                <td>${file.originalFileName}</td>
                                <td>${(file.fileSize / 1024).toFixed(2)} KB</td>
                                <td>${new Date(file.uploadDate).toLocaleString()}</td>
                                <td>
                                    <button onclick="displayDataFromFile('${file.fileName}')">??? G�ster</button>
                                    <button onclick="exportDataFromFile('${file.fileName}')">?? �ndir</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>Hen�z y�klenmi� dosya yok.</p>';
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">? Dosya listesi y�klenemedi: ${error.message}</div>`;
            }
        }
        
        // Veri g�r�nt�leme
        async function displayData() {
            const fileName = document.getElementById('displayFileName').value;
            const sheetName = document.getElementById('displaySheetName').value || undefined;
            const page = parseInt(document.getElementById('pageNumber').value) || 1;
            const container = document.getElementById('data-display');
            
            if (!fileName) {
                alert('Dosya ad� gerekli');
                return;
            }
            
            try {
                container.innerHTML = '?? Veriler y�kleniyor...';
                
                const result = await window.excelService.getExcelData(fileName, sheetName, page, 20);
                
                if (result.success && result.data && result.data.length > 0) {
                    const columns = Object.keys(result.data[0].data || {});
                    
                    let html = `
                        <p><strong>Dosya:</strong> ${fileName} | <strong>Sayfa:</strong> ${page}</p>
                        <table>
                            <tr>
                                <th>ID</th>
                                <th>Sat�r No</th>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                                <th>G�ncelleme</th>
                                <th>��lemler</th>
                            </tr>
                    `;
                    
                    result.data.forEach(row => {
                        html += `
                            <tr>
                                <td>${row.id}</td>
                                <td>${row.rowIndex}</td>
                                ${columns.map(col => `<td>${row.data[col] || ''}</td>`).join('')}
                                <td>${row.modifiedDate ? new Date(row.modifiedDate).toLocaleString() : 'Hi�'}</td>
                                <td>
                                    <button onclick="editRow(${row.id})">?? D�zenle</button>
                                    <button onclick="deleteRow(${row.id})">??? Sil</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    
                    // Sayfalama kontrollar�
                    html += `
                        <div style="margin-top: 10px;">
                            <button onclick="document.getElementById('pageNumber').value = ${page - 1}; displayData();" ${page <= 1 ? 'disabled' : ''}>?? �nceki</button>
                            <span> Sayfa ${page} </span>
                            <button onclick="document.getElementById('pageNumber').value = ${page + 1}; displayData();">?? Sonraki</button>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>Veri bulunamad�.</p>';
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">? Veri y�kleme hatas�: ${error.message}</div>`;
            }
        }
        
        // Dosya listesinden veri g�sterme
        function displayDataFromFile(fileName) {
            document.getElementById('displayFileName').value = fileName;
            document.getElementById('pageNumber').value = 1;
            displayData();
        }
        
        // Dosya kar��la�t�rma
        async function compareFiles() {
            const fileName1 = document.getElementById('compareFile1').value;
            const fileName2 = document.getElementById('compareFile2').value;
            const sheetName = document.getElementById('compareSheetName').value || undefined;
            const container = document.getElementById('comparison-result');
            
            if (!fileName1 || !fileName2) {
                alert('�ki dosya ad� da gerekli');
                return;
            }
            
            try {
                container.innerHTML = '?? Dosyalar kar��la�t�r�l�yor...';
                
                const result = await window.excelService.compareExcelFiles(fileName1, fileName2, sheetName);
                
                if (result.success && result.data) {
                    const data = result.data;
                    let html = `
                        <h3>?? Kar��la�t�rma Sonucu</h3>
                        <p><strong>Dosya 1:</strong> ${data.file1Name}</p>
                        <p><strong>Dosya 2:</strong> ${data.file2Name}</p>
                        
                        <h4>?? �zet</h4>
                        <ul>
                            <li>?? Toplam Sat�r: ${data.summary.totalRows}</li>
                            <li>?? De�i�tirilen: ${data.summary.modifiedRows}</li>
                            <li>? Eklenen: ${data.summary.addedRows}</li>
                            <li>? Silinen: ${data.summary.deletedRows}</li>
                            <li>? De�i�meyen: ${data.summary.unchangedRows}</li>
                        </ul>
                    `;
                    
                    if (data.differences && data.differences.length > 0) {
                        html += `
                            <h4>?? Farkl�l�klar (${data.differences.length} adet)</h4>
                            <table>
                                <tr><th>Sat�r</th><th>S�tun</th><th>Eski De�er</th><th>Yeni De�er</th><th>Tip</th></tr>
                        `;
                        
                        data.differences.slice(0, 50).forEach(diff => { // �lk 50 farkl�l��� g�ster
                            html += `
                                <tr>
                                    <td>${diff.rowIndex}</td>
                                    <td>${diff.columnName}</td>
                                    <td>${diff.oldValue || ''}</td>
                                    <td>${diff.newValue || ''}</td>
                                    <td>${diff.type}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                        
                        if (data.differences.length > 50) {
                            html += `<p><em>... ve ${data.differences.length - 50} farkl�l�k daha</em></p>`;
                        }
                    }
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">? Kar��la�t�rma hatas�: ${error.message}</div>`;
            }
        }
        
        // Yeni sat�r ekleme
        async function addRow() {
            const fileName = document.getElementById('addFileName').value;
            const sheetName = document.getElementById('addSheetName').value;
            const rowDataText = document.getElementById('addRowData').value;
            
            if (!fileName || !sheetName || !rowDataText) {
                alert('T�m alanlar gerekli');
                return;
            }
            
            try {
                const rowData = JSON.parse(rowDataText);
                const userEmail = prompt('Email adresiniz:') || undefined;
                
                const result = await window.excelService.addRow(fileName, sheetName, rowData, userEmail);
                
                if (result.success) {
                    alert('? Yeni sat�r eklendi');
                    document.getElementById('addRowData').value = '';
                } else {
                    alert('? Sat�r eklenemedi');
                }
            } catch (error) {
                alert(`? Hata: ${error.message}`);
            }
        }
        
        // Excel export
        async function exportData() {
            const fileName = document.getElementById('exportFileName').value;
            const sheetName = document.getElementById('exportSheetName').value || undefined;
            const includeHistory = document.getElementById('includeHistory').checked;
            
            if (!fileName) {
                alert('Dosya ad� gerekli');
                return;
            }
            
            try {
                const blob = await window.excelService.exportToExcel(fileName, sheetName, undefined, includeHistory);
                
                // Dosyay� indir
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('? Dosya indirildi');
            } catch (error) {
                alert(`? Export hatas�: ${error.message}`);
            }
        }
        
        // Dosya listesinden export
        function exportDataFromFile(fileName) {
            document.getElementById('exportFileName').value = fileName;
            exportData();
        }
        
        // API testleri
        async function testExcelApi() {
            const container = document.getElementById('test-results');
            try {
                const result = await window.excelService.testApi();
                container.innerHTML = `<div class="status success">? Excel API Test: ${result.message}</div>`;
            } catch (error) {
                container.innerHTML = `<div class="status error">? Excel API Test Hatas�: ${error.message}</div>`;
            }
        }
        
        async function testComparisonApi() {
            const container = document.getElementById('test-results');
            try {
                const result = await window.excelService.testComparisonApi();
                container.innerHTML = `<div class="status success">? Comparison API Test: ${result.message}</div>`;
            } catch (error) {
                container.innerHTML = `<div class="status error">? Comparison API Test Hatas�: ${error.message}</div>`;
            }
        }
        
        // Sat�r d�zenleme
        async function editRow(id) {
            const newValue = prompt('Yeni de�eri JSON format�nda girin:\n�rnek: {"Ad": "Ahmet", "Soyad": "Y�lmaz"}');
            if (!newValue) return;
            
            try {
                const data = JSON.parse(newValue);
                const userEmail = prompt('Email adresiniz:') || undefined;
                
                const result = await window.excelService.updateData(id, data, userEmail);
                
                if (result.success) {
                    alert('? Veri g�ncellendi');
                    displayData(); // Tabloyu yenile
                } else {
                    alert('? G�ncelleme ba�ar�s�z');
                }
            } catch (error) {
                alert(`? G�ncelleme hatas�: ${error.message}`);
            }
        }
        
        // Sat�r silme
        async function deleteRow(id) {
            if (!confirm('Bu sat�r� silmek istedi�inizden emin misiniz?')) {
                return;
            }
            
            try {
                const userEmail = prompt('Email adresiniz:') || undefined;
                const result = await window.excelService.deleteData(id, userEmail);
                
                if (result.success) {
                    alert('? Veri silindi');
                    displayData(); // Tabloyu yenile
                } else {
                    alert('? Silme ba�ar�s�z');
                }
            } catch (error) {
                alert(`? Silme hatas�: ${error.message}`);
            }
        }
    </script>
</body>
</html>